<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Midway Development Guide | Midway</title>
    <meta name="description" content="面向未来的 Web 全栈应用开发框架">
    
    
    <link rel="preload" href="/midway/assets/css/0.styles.da0256d7.css" as="style"><link rel="preload" href="/midway/assets/js/app.d7607e40.js" as="script"><link rel="preload" href="/midway/assets/js/5.f263d692.js" as="script"><link rel="prefetch" href="/midway/assets/js/10.6b17aa1c.js"><link rel="prefetch" href="/midway/assets/js/2.7974f97d.js"><link rel="prefetch" href="/midway/assets/js/3.02e773fe.js"><link rel="prefetch" href="/midway/assets/js/4.9678ba40.js"><link rel="prefetch" href="/midway/assets/js/6.262bb466.js"><link rel="prefetch" href="/midway/assets/js/7.5754b886.js"><link rel="prefetch" href="/midway/assets/js/8.b0315e89.js"><link rel="prefetch" href="/midway/assets/js/9.ad7e72e1.js">
    <link rel="stylesheet" href="/midway/assets/css/0.styles.da0256d7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/midway/" class="home-link router-link-active"><!----> <span class="site-name">Midway</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link">使用文档</a></div><div class="nav-item"><a href="/midway/ioc.html" class="nav-link">依赖注入手册</a></div><div class="nav-item"><a href="/midway/tool_set.html" class="nav-link">工具集</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="http://www.midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/en/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div> <a href="https://github.com/midwayjs/midway" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link">使用文档</a></div><div class="nav-item"><a href="/midway/ioc.html" class="nav-link">依赖注入手册</a></div><div class="nav-item"><a href="/midway/tool_set.html" class="nav-link">工具集</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="http://www.midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/en/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div> <a href="https://github.com/midwayjs/midway" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="midway-development-guide"><a href="#midway-development-guide" aria-hidden="true" class="header-anchor">#</a> Midway Development Guide</h1> <h2 id="introduction"><a href="#introduction" aria-hidden="true" class="header-anchor">#</a> Introduction</h2> <p>Since 2013, Midway has kept upgrading almost every year, from Express to Koa1/2 without absence of trend.</p> <p>Nowadays, Node.js goes ahead of the simple single-page application, not only in the Alibaba Group but also the Community, and go toward to the full-stack. With this trending, the MidwayJs Team come with the responsibility of supporting the Alibaba Group's Node.js Applications, and we also provide tools like <code>Pandora.js</code>, <code>Sandbox</code> to help Applications become more stable and reliable.</p> <p>During 2017, we upgraded the Midway core to Koa2 to support async/await by Midway v5.3 inside the Alibaba Group.
''
At the same year, we started planning to separate the monitoring and statistic function from the framework, which became the Pandora.js, a tool that is not just serve the Midway, but can be general using for any Node.js applications.</p> <p>In 2018, the MidwayJs Team improved the development experience from the language level by Typescript, and released Midway v6.0 which is the 1.0 open source version to community.</p> <p>As for the reason why we choose Typescript, this <a href="https://juejin.im/post/59c46bc86fb9a00a4636f939" target="_blank" rel="noopener noreferrer">post<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> may give you answer.</p> <h2 id="about"><a href="#about" aria-hidden="true" class="header-anchor">#</a> About</h2> <p>The Midway is a full-stack development solution which developed by the frontend team of Taobao technique department (i.e. Taobao UED). It cooperate with Pandora and Sandbox to perfect the Node.js development experience in new scene.</p> <h2 id="quickly-start"><a href="#quickly-start" aria-hidden="true" class="header-anchor">#</a> Quickly start</h2> <h3 id="install-node-js"><a href="#install-node-js" aria-hidden="true" class="header-anchor">#</a> Install Node.js</h3> <p>Visit the office website of Node.js or using the tools like nvm.</p> <h3 id="new-project"><a href="#new-project" aria-hidden="true" class="header-anchor">#</a> New project</h3> <p>Using the <a href="https://www.npmjs.com/package/midway-init" target="_blank" rel="noopener noreferrer">midway-init<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> tool to automatic create a Midway Application directory:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i midway-init -g
$ midway-init
</code></pre></div><p>We can use the <code>npm scripts</code> commands to startup:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span>
$ <span class="token function">npm</span> run dev
</code></pre></div><h3 id="directory-structure"><a href="#directory-structure" aria-hidden="true" class="header-anchor">#</a> Directory structure</h3> <p>The structure of Midway is similar to Eggjs, but there are still differences:</p> <ul><li>TypeScript code is located in <code>src/</code>, and built out <code>dist/</code>.</li> <li>The original <code>app/</code> is moved to <code>src/app/</code>.</li> <li>It is suggested that write your business logic to the <code>lib/</code>, such as <code>lib/service</code>.</li></ul> <div class="language-plain extra-class"><pre class="language-text"><code>➜  midway6-test tree -I node_modules
.
├── README.md
├── README.zh-CN.md
├── dist                                ---- built source code
├── logs                                ---- local logs
│   └── midway6-test                    ---- logs about application name
│       ├── common-error.log            ---- error logs
│       ├── midway-agent.log            ---- agent logs
│       ├── midway-core.log             ---- framework level logs
│       ├── midway-web.log              ---- koa logs
│       └── midway6-test-web.log
├── package.json
├── src                                 ---- source code
│   ├── app                             ---- web application
│   │   ├── controller                  ---- web controllers
│   │   │   ├── home.ts
│   │   │   └── user.ts
│   │   ├── middleware (opt)            ---- web middleware
│   │   │   └── trace.ts
│   │   ├── public (opt)                ---- web static resource
│   │   ├── view (opt)
│   │   |   └── home.tpl                ---- web templates
│   ├── config
│   │   ├── config.default.ts
│   │   ├── config.local.ts
│   │   ├── config.prod.ts
│   │   ├── config.unittest.ts
│   │   └── plugin.ts
│   └── lib                             ---- business logics (user define)
│   │   └── service                     ---- services (user define)
│   │       └── user.ts
│   ├── interface.ts                    ---- interface definition (user define)
│   ├── app.ts (opt)                    ---- application extend file
│   └── agent.ts (opt)                  ---- agent extend file
├── test
│   └── app
│       └── controller
│           └── home.test.ts
├── tsconfig.json
└── tslint.json
</code></pre></div><p>Cause the Midway is using EggJs as Web container which means the MVC works it under it's system. so there are some implicit directory rules:</p> <ul><li><code>src/app/router.ts</code>( optional) to config the URL route rules, see <a href="https://eggjs.org/en/basics/router.html" target="_blank" rel="noopener noreferrer">Router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/app/controller/**</code> to write controllers, see  <a href="https://eggjs.org/en/basics/controller.html" target="_blank" rel="noopener noreferrer">Controller<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/app/middleware/**</code> (optional) to define user middlewares, see  <a href="https://eggjs.org/en/basics/middleware.html" target="_blank" rel="noopener noreferrer">Middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/app/extend/**</code> (optional) to configure multiple extensions, see <a href="https://eggjs.org/en/basics/extend.html" target="_blank" rel="noopener noreferrer">Extend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/config/config.{env}.ts</code> to write config files, see <a href="https://eggjs.org/en/basics/config.html" target="_blank" rel="noopener noreferrer">Config<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/config/plugin.ts</code> to setup the plugin which you need, see <a href="https://eggjs.org/en/basics/plugin.html" target="_blank" rel="noopener noreferrer">Plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>test/**</code> for unit test, see <a href="https://eggjs.org/en/core/unittest.html" target="_blank" rel="noopener noreferrer">Unit testing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/app.ts</code> and <code>agent.ts</code> (optional) see <a href="https://eggjs.org/en/basics/app-start.html" target="_blank" rel="noopener noreferrer">Application Startup Configuration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. As for <code>agent.js</code>, see <a href="https://eggjs.org/en/core/cluster-and-ipc.html#agent-mechanism" target="_blank" rel="noopener noreferrer">Agent mechanism<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li></ul> <p>And for Egg plugins' compatibility, there are also some implicit rules, like:</p> <ul><li><code>src/app/public/**</code> (optional) is for static resources, see the inner plugin <a href="https://github.com/eggjs/egg-static" target="_blank" rel="noopener noreferrer">egg-static<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li> <li><code>src/app/view/**</code>  (optional) is for templates files which managed by template plugin, see <a href="https://eggjs.org/en/core/view.html" target="_blank" rel="noopener noreferrer">View Template Rendering<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</li></ul> <p>We would find that the source code all locate on <code>src/</code>. If you using the <code>ts</code> mode, which is default, the compiled <code>*.js</code> code will locate in <code>dist/</code>.</p> <p>Actually, the directories except <code>app/</code>, which is not necessary to compatible with old things, has no strict or implicit rules under Midway framework. We can freely define directories, like traditional <code>web, biz, service, manager, dao</code> etc.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>With the Midway features like automatic scanner and IoC, we don't need to use fixed directory rules, that make development more flexible.</p></div> <h2 id="quick-guide"><a href="#quick-guide" aria-hidden="true" class="header-anchor">#</a> Quick Guide</h2> <p>To quickly use the Midway, you need more things like:</p> <ul><li>Learn basic Typescript, there is <a href="/midway/en/ts_start.html">quick start</a>.</li> <li>Object oriented is recommended, you will feel free if you like <code>class</code>.</li> <li>Quick look at IoC and decorators, <a href="/midway/en/ioc.html">introduction  of IoC</a>.</li> <li>If you wanna know more detail about some implicit function, don't forget the <a href="https://eggjs.org/en/intro/" target="_blank" rel="noopener noreferrer">Egg documents<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or report us <a href="https://github.com/midwayjs/midway/issues" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <h2 id="the-same-part-of-egg"><a href="#the-same-part-of-egg" aria-hidden="true" class="header-anchor">#</a> The same part of Egg</h2> <p>The biggest difference of the Midway and Egg, is the <code>*.ts</code> extensions, and the base dir (Midway use <code>src/</code>)。</p> <h3 id="runtime-environment"><a href="#runtime-environment" aria-hidden="true" class="header-anchor">#</a> Runtime Environment</h3> <p>No changes, see <a href="https://eggjs.org/en/basics/env.html" target="_blank" rel="noopener noreferrer">egg doc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <h3 id="config"><a href="#config" aria-hidden="true" class="header-anchor">#</a> Config</h3> <p>Midway use <code>*.ts</code> as default, see <a href="https://eggjs.org/en/basics/env.html#configure-runtime-environment" target="_blank" rel="noopener noreferrer">Configure Runtime Environment<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <div class="language-text extra-class"><pre class="language-text"><code>src/config
|- config.default.ts
|- config.prod.ts
|- config.unittest.ts
`- config.local.ts
</code></pre></div><h3 id="web-middleware"><a href="#web-middleware" aria-hidden="true" class="header-anchor">#</a> Web middleware</h3> <p>Except files locate on <code>src/app/middleware</code> and extension change to <code>*.ts</code>, there is no difference, see <a href="https://eggjs.org/en/basics/middleware.html" target="_blank" rel="noopener noreferrer">Middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <h3 id="router"><a href="#router" aria-hidden="true" class="header-anchor">#</a> Router</h3> <p>There is still <code>src/app/router.ts</code> file, but recommend the <a href="#router-decorator">router decorator</a> of Midway instead of <a href="https://eggjs.org/en/basics/router.html" target="_blank" rel="noopener noreferrer">egg router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="extend"><a href="#extend" aria-hidden="true" class="header-anchor">#</a> Extend</h3> <p>Same function with egg but new place <code>src/app/*.ts</code> without change, see <a href="https://eggjs.org/en/basics/extend.html" target="_blank" rel="noopener noreferrer">Extend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <h3 id="application-startup-configuration"><a href="#application-startup-configuration" aria-hidden="true" class="header-anchor">#</a> Application Startup Configuration</h3> <p>New palce <code>src/app.ts</code>, see <a href="https://eggjs.org/en/basics/app-start.html" target="_blank" rel="noopener noreferrer">App start<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <p>To get the IoC Context in <code>app.ts</code>, you could try this.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// app.js</span>
<span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> app <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// Get singleton object by global scope</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get object by current request scope</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="router-controller"><a href="#router-controller" aria-hidden="true" class="header-anchor">#</a> Router &amp; Controller</h2> <p>Midway use the <code>koa-router</code> as router solution, and provide more syntactic sugar that users can easyly declare router and controller with decorators by TypeScript.</p> <h3 id="router-decorator"><a href="#router-decorator" aria-hidden="true" class="header-anchor">#</a> Router decorator</h3> <p>In new ts system, our controller directory is <code>app/controller</code>, we  write <code>*.ts</code> files inside. Such as the <code>userController.ts</code> below, we provide  a interface to get user's information.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
  service<span class="token punctuation">:</span> IUserService<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id<span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user<span class="token punctuation">:</span> IUserResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> user<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can use <code>@controller</code> decorator to declare this class as a Controller. And there is function decorator for different request types.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Actually, the string in <code>@controller(string)</code> is just what we pass to <code>router.prefix(string)</code>.</p></div> <p>For web request, Midway provide corresponding function decorator of koa-router:</p> <ul><li>@get</li> <li>@post</li> <li>@del</li> <li>@put</li> <li>@patch</li> <li>@options</li> <li>@head</li> <li>@all</li></ul> <p>These decorators is for different async functions, and has the similar meaning of koa-router's. Like original koa2 routers, every router method is async, and got koa context as parameter.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO ctx...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="router-binding"><a href="#router-binding" aria-hidden="true" class="header-anchor">#</a> router binding</h3> <p>As the way in elder framework you can directly use <code>app/router.ts</code> file to declare your routers. But with the new IoC feature there are some differences come.</p> <p>The focus is we need to <strong>get the controllers from container</strong>, then bind it.</p> <p>In case we have a controller and this controller didn't declare by <code>@controller</code>, that means it wouldn't be recognized as a controller by Midway and would not be automatically bind to some router, but if you <code>@provide</code> it, it will be loaded by IoC container.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/controller/api.ts</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseApi</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As if we want binding this to a router:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/router.ts</span>

<span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/index'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">generateController</span><span class="token punctuation">(</span><span class="token string">'baseApi.index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>There is a simply method for this step named <code>app.generateController</code> in Midway, and in form of <code>ClassName.methodName</code>.</p> <h3 id="router-priorities"><a href="#router-priorities" aria-hidden="true" class="header-anchor">#</a> router priorities</h3> <p>In SPA scene, there always is <code>/*</code> router. we could adjust the code line order to sort it in the past, but due to the decorator way, it may be undefined order for some kind of routers. So Midway provide <code>@priority(priority: number)</code> for setting the priority. default priority is <code>0</code>, we can also set minus number to downgrade.</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">priority</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">all</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="enhanced-injection"><a href="#enhanced-injection" aria-hidden="true" class="header-anchor">#</a> Enhanced injection</h2> <p>Midway use <a href="http://web.npm.alibaba-inc.com/package/injection" target="_blank" rel="noopener noreferrer">injection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as default IoC tool. Though <code>@inject</code> can satisfy most business logic, for framework there are still places to be extended like plugin, config etc.</p> <h3 id="plugin-inject"><a href="#plugin-inject" aria-hidden="true" class="header-anchor">#</a> Plugin inject</h3> <p>Except the <code>app.xxx</code> plugin usage which supported by eggjs, Midway support we to inject a plugin by <code>@plugin</code>. If we have a plugin named <code>plugin2</code>, we could try the new way:</p> <div class="warning custom-block"><p class="custom-block-title">Warning</p> <p>Cause the midway inner plugin is not store in applicationContext, we couldn't use <code>@inject</code> for plugin.</p></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'plugin2'</span><span class="token punctuation">)</span>
  plugin<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>So that we got <code>this.plugin</code> in BaseService with <code>@plugin</code> by it's name.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Plugin is singleton in Midway.</p></div> <h3 id="get-plugin-name"><a href="#get-plugin-name" aria-hidden="true" class="header-anchor">#</a> Get plugin name</h3> <p>A plugin name to retrieve from pluginContext is depending on the plugin implement. Midway would use the property name, which was mounted by plugin, as the basic key.</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// what egg plugins usually do</span>
  app<span class="token punctuation">.</span>plugin1 <span class="token operator">=</span> xxxx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then <code>plugin1</code> is the plugin key, Midway will automatically store the object to pluginContext while plugin call app.[#setter], so that we can inject it to some property in a class by <code>@plugin</code>.</p> <h3 id="config-inject"><a href="#config-inject" aria-hidden="true" class="header-anchor">#</a> Config inject</h3> <p>In midway, the config of different environment  would be mounted to <code>app.config</code>, but not all the business logic need the app object. So we provide <code>@config</code> for retrieving the config values.</p> <p>For example in <code>config.default.ts</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>so we can inject it by:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  config<span class="token punctuation">;</span>   <span class="token comment">// 1</span>

<span class="token punctuation">}</span>
</code></pre></div><p>So that we can inject the config values into the business logic without coupling.</p> <h3 id="schedule-task"><a href="#schedule-task" aria-hidden="true" class="header-anchor">#</a> Schedule task</h3> <p>The schedule of midawy is based on <a href="https://eggjs.org/en/basics/schedule.html" target="_blank" rel="noopener noreferrer">egg schedule<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and provide more typescript and decorator support. The task all store in <code>lib/schedule</code>, every file is single schedule task which can be configured the properties and specify jobs. For example:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// src/lib/schedule/hello.ts</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> schedule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  interval<span class="token punctuation">:</span> <span class="token number">2333</span><span class="token punctuation">,</span> <span class="token comment">// 2.333s interval</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'worker'</span><span class="token punctuation">,</span> <span class="token comment">// only run in certain worker</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloCron</span> <span class="token punctuation">{</span>
  <span class="token comment">// The detail job while times up</span>
  <span class="token keyword">async</span> <span class="token function">exec</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PS: The schedule class need <code>export</code> to be loadable. And the <code>.ts</code> file can <code>export</code> multi schedule class except <code>default class</code>.</p> <h3 id="logger-inject"><a href="#logger-inject" aria-hidden="true" class="header-anchor">#</a> Logger inject</h3> <p>In the past, logger object is mounted on app.loggers. By configure the config file, we can generate different logger object, like <code>customLogger</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> appInfo <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    customLogger<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      xxLogger<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        file<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">'logs/xx.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Then you can get logger object instance by <code>@logger</code>.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'customLogger'</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="logger-in-requestcontext"><a href="#logger-in-requestcontext" aria-hidden="true" class="header-anchor">#</a> logger in requestContext</h3> <p>In the latest version, Midway enable requestContext for all objects. During this scope, every object has a default logger object.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>This logger object is inject into the IoC container at every request come in. So we can use <code>@inject</code> to retrieve it. When the <code>str</code> of <code>@inject(str)</code> is empty, it will use the property name as the <code>str</code> to retrieve. In this case, the logger object's key is just <code>logger</code>.</p></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

  <span class="token comment">// explicit key</span>
  <span class="token comment">// @inject('logger')</span>
  <span class="token comment">// logger;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="framework-extend"><a href="#framework-extend" aria-hidden="true" class="header-anchor">#</a> Framework Extend</h2> <p>Eggjs provide extensible application/context/request/response. based on it, Midway do some extending on IoC.</p> <h3 id="application-扩展"><a href="#application-扩展" aria-hidden="true" class="header-anchor">#</a> Application 扩展</h3> <p>see <a href="https://midwayjs.org/midway/api-reference/classes/midwayapplication.html" target="_blank" rel="noopener noreferrer">API doc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more.</p> <p><strong>baseDir</strong></p> <p>Due to the typescript compiling, Midway's app.baseDir was point to <code>src/</code> while develop and point to <code>dist/</code> after built start.</p> <p><strong>appDir</strong></p> <p>because of the changing baseDir, we add a <code>app.appDir</code> for retrieving the root directory of application.</p> <p><strong>applicationContext</strong></p> <p><code>app.applicationContext</code> is for global scope IoC container, and all the singleton object store inside. Usage:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>pluginContext</strong></p> <p>Container for plugin, to store all the plugins which mount on app.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> app<span class="token punctuation">.</span>pluginContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'pluginName'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="context-extend"><a href="#context-extend" aria-hidden="true" class="header-anchor">#</a> Context extend</h3> <p><strong>requestContext</strong></p> <p>For the context under request, we extend the <code>requestContext</code> property. it's similar with <code>applicationContext</code>, is a IoC container too. it is used to store the objects during once request, which would be delete while request over.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="application-test"><a href="#application-test" aria-hidden="true" class="header-anchor">#</a> Application Test</h2> <p>After a lot of practice, we have a standard set of test tools.</p> <ul><li>Toolkit: <a href="https://www.npmjs.com/package/midway-bin" target="_blank" rel="noopener noreferrer">midway-bin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Framework: mocha</li> <li>Assert library: assert/chai</li> <li>Mock: <a href="https://www.npmjs.com/package/midway-mock" target="_blank" rel="noopener noreferrer">midway-mock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="directory-structure-2"><a href="#directory-structure-2" aria-hidden="true" class="header-anchor">#</a> Directory Structure</h3> <p>Test code is demand to be put in <code>test/</code> directory, include <code>fixtures/</code> and assistant scripts.</p> <p>Each Test file has to be named by the pattern of <code>${filename}.test.ts</code>, ending with <code>.test.ts</code>.</p> <p>For example:</p> <div class="language-plain extra-class"><pre class="language-text"><code>test
├── controller
│   └── home.test.ts
├── hello.test.ts
└── service
    └── user.test.ts

</code></pre></div><h3 id="test-tool"><a href="#test-tool" aria-hidden="true" class="header-anchor">#</a> Test Tool</h3> <p>Consistently using <code>midway-bin</code> to launch tests , which automatically loads modules like Mocha, co-mocha, power-assert, nyc into test scripts, so that we can concentrate on writing tests without wasting time on the choice of various test tools or modules.</p> <p>The only thing you need to do is setting <code>scripts.test</code> in <code>package.json</code>.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin test --ts&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cov&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin cov --ts&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then tests would be launched by executing <code>npm test</code> command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">test</span>

<span class="token operator">&gt;</span> unittest-example@ <span class="token function">test</span> /Users/harry/midwayj/examples/unittest
<span class="token operator">&gt;</span> midway-bin <span class="token function">test</span> --ts

  test/hello.test.ts
    ✓ should work

  1 passing <span class="token punctuation">(</span>10ms<span class="token punctuation">)</span>

</code></pre></div><h3 id="start-test"><a href="#start-test" aria-hidden="true" class="header-anchor">#</a> Start test</h3> <p>Before launching, we have to create an instance of App to test code of application-level like Controller, Middleware or Service.</p> <p>We can easily create an app instance with Mocha's <code>before</code> hook through <code>midway-mock</code>.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.js</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token punctuation">;</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// create a current app instance</span>
    app <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// execute tests after app is ready</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, we have an app instance, and it's the base of all the following tests. See more about app at <a href="https://github.com/eggjs/egg-mock#options" target="_blank" rel="noopener noreferrer">mm.app(options)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>It's redundancy to create an instance in each test file, so we offered an bootstrap file in <code>midway-mock</code> to create it conveniently.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// test cases</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="controller-test"><a href="#controller-test" aria-hidden="true" class="header-anchor">#</a> Controller Test</h3> <p>We could use <code>app.httpRequest()</code> to make a real HTTP request to test. And <code>app.httpRequest()</code> is a request instance <a href="https://github.com/visionmedia/supertest" target="_blank" rel="noopener noreferrer">SuperTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> encapsulated by midway-mock.</p> <p>Here is an <code>app/controller/home.ts</code> example:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> controller<span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>
  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Welcome to midwayjs!`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then a test for it:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should GET /'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// request `GET /`</span>
    <span class="token keyword">return</span> app
      <span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Welcome to midwayjs!'</span><span class="token punctuation">)</span> <span class="token comment">// expect body equals 'Welcome to midwayjs!'</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// expect the http status is 200</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>app.httpRequest()</code> based on SuperTest supports a majority of HTTP methods such as GET, POST, PUT, and it provides rich interfaces to construct request, such as a JSON POST request.</p> <h3 id="service-test"><a href="#service-test" aria-hidden="true" class="header-anchor">#</a> Service Test</h3> <p>Cause Midway suggest use IoC way to write service, so it's coding and testing have obvious difference with Eggjs.</p> <p>Such as <code>src/lib/service/user.ts</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService<span class="token punctuation">,</span> IUserOptions<span class="token punctuation">,</span> IUserResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../interface'</span><span class="token punctuation">;</span>

<span class="token comment">// Load the service to IoC container</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> IUserOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// return the user data after 10ms</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> options<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          username<span class="token punctuation">:</span> <span class="token string">'mockedName'</span><span class="token punctuation">,</span>
          phone<span class="token punctuation">:</span> <span class="token string">'12345678901'</span><span class="token punctuation">,</span>
          email<span class="token punctuation">:</span> <span class="token string">'xxx.xxx@xxx.com'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Write the unit test <code>test/service/user.test.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../src/interface'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/service/user.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'#getUser'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取出 userService</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span>getAsync<span class="token operator">&lt;</span>IUserService<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token string">'mockedName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>app.applicationContext is the application context of IoC Container, we can asynchronizely get the injected service object and use it for testing. Click <a href="https://github.com/Lellansin/midway-test-demo" target="_blank" rel="noopener noreferrer">midway-test-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the whole demo.</p> <h2 id="deployment"><a href="#deployment" aria-hidden="true" class="header-anchor">#</a> Deployment</h2> <h3 id="building"><a href="#building" aria-hidden="true" class="header-anchor">#</a> Building</h3> <p>Because Typescript is a language that need to compile, so we could using tools like <code>ts-node</code> to develop locally. In server side, we hope using the compiled JavaScript code to run for better performance.</p> <p>Thanks to the tool <code>tsc</code> which provided by Typescript office to do this job. It will auto load the <code>tsconfig.json</code> to do some compiler setups, and Midway has provide a template setup in default, but it can be edited by us freely. And, we provide <code>build</code> command to help user simply using it.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>recommend to build in local and try to launch it by <code>npm run start_build</code> which could reduce the CI build errors.</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token string">&quot;start_build&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;npm run build &amp;&amp; NODE_ENV=development midway-bin dev&quot;</span>
</code></pre></div><p>With start_build command, it will automaticly compile and start the application with code under <code>dist/</code>.</p> <p>If you have some resources to copy to <code>dist/</code>, see <a href="/midway/en/tool_set.html#build-命令">Build command</a> for more.</p> <h3 id="file-startup"><a href="#file-startup" aria-hidden="true" class="header-anchor">#</a> file startup</h3> <p>The Midway provide a inner <code>server.js</code> file as the application's start entry. In most cases, you can startup the application by directly require this file.</p> <p>For example, start by pm2:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// xxx.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'midway/server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Or through pandora usage, there will be <code>procfile.js</code> file automaticly generated, like:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> pandora <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  pandora
    <span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'[your app name]'</span><span class="token punctuation">,</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'midway/server'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="egg-scripts-startup"><a href="#egg-scripts-startup" aria-hidden="true" class="header-anchor">#</a> egg-scripts startup</h3> <p>There is a compatible startup way (from egg) by egg-scripts, but without <a href="#startup-parameters">startup parameters</a>  support.</p> <p>Please see <a href="https://eggjs.org/en/core/deployment.html" target="_blank" rel="noopener noreferrer">egg-scripts deployment<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more details.</p> <h3 id="startup-parameters"><a href="#startup-parameters" aria-hidden="true" class="header-anchor">#</a> startup parameters</h3> <p>We design a mechanisms, that configure the server configs in <code>package.json</code> with <code>midway/server</code> file only.</p> <p>See <a href="https://github.com/eggjs/egg-cluster/blob/master/lib/master.js#L33" target="_blank" rel="noopener noreferrer">this<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more parameters support, and there are extra params in Midway:</p> <ul><li>typescript {boolean} if true, enable ts mode, load <code>src/</code> or <code>dist/</code> code. it's not necessary to set it manually that Midway will judge it automatically.</li> <li>srcDir {string} srouce code directory, default value is <code>src/</code>.</li> <li>targetDir {string} compiled code directory, default value is <code>dist/</code>.</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;midway-server-options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;workers&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">3000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can also define it in js or json file instead of package.json:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;midway-server-options&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;./server.json&quot;</span>    <span class="token comment">// xxx.js</span>
<span class="token punctuation">}</span>

<span class="token comment">// in json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;workers&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// in js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  workers<span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="others"><a href="#others" aria-hidden="true" class="header-anchor">#</a> Others</h2> <h3 id="lack-of-windows-support"><a href="#lack-of-windows-support" aria-hidden="true" class="header-anchor">#</a> Lack of Windows support</h3> <p>Due to some library and plugin dependencies compatible limit, the development experience is not perfect on Windows Platform. So we suggest using the Midway on Mac/Linux first.</p> <p>We just verified Midway by Node.js v10 under the Windows 10, but there is no office support upon others Windows version.</p> <p>It's recommended that use the more friendly tools like <a href="https://hyper.is/" target="_blank" rel="noopener noreferrer">Hyper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> instead of native CLI.</p> <p>BTW, cause the env sync of Windows, the default template of Midway may need adjust the environments manually. Such as, the <code>dev</code> script of package.json, you may use <code>set</code> to explicit setup the env like:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set NODE_ENV=local &amp;&amp; midway-bin dev --ts&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/midwayjs/midway/edit/master/docs/en/guide.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/midway/assets/js/app.d7607e40.js" defer></script><script src="/midway/assets/js/5.f263d692.js" defer></script>
  </body>
</html>
