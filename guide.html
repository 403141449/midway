<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Midway 开发指南 | Midway</title>
    <meta name="description" content="面向未来的 Web 全栈应用开发框架">
    
    
    <link rel="preload" href="/midway/assets/css/styles.11a95031.css" as="style"><link rel="preload" href="/midway/assets/js/app.11a95031.js" as="script"><link rel="preload" href="/midway/assets/js/6.5a189156.js" as="script"><link rel="prefetch" href="/midway/assets/css/1.styles.b05fc641.css"><link rel="prefetch" href="/midway/assets/css/2.styles.f6e3173e.css"><link rel="prefetch" href="/midway/assets/js/1.b05fc641.js"><link rel="prefetch" href="/midway/assets/js/2.f6e3173e.js"><link rel="prefetch" href="/midway/assets/js/3.9fb9099a.js"><link rel="prefetch" href="/midway/assets/js/4.3438062f.js"><link rel="prefetch" href="/midway/assets/js/5.76c1cc23.js"><link rel="prefetch" href="/midway/assets/js/7.c3518a58.js">
    <link rel="stylesheet" href="/midway/assets/css/1.styles.b05fc641.css"><link rel="stylesheet" href="/midway/assets/css/2.styles.f6e3173e.css"><link rel="stylesheet" href="/midway/assets/css/styles.11a95031.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/midway/" class="home-link router-link-active"><!----> <span class="site-name">Midway</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">使用指南</a></div><div class="nav-item"><a href="http://www.midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div> <a href="https://github.com/midwayjs/midway" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">使用指南</a></div><div class="nav-item"><a href="http://www.midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/.html#" class="nav-link">Sandbox - 私有化 Node.js 监控产品</a></li></ul></li></ul></div></div> <a href="https://github.com/midwayjs/midway" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Midway 开发指南</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/midway/guide.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/midway/guide.html#关于-midway" class="sidebar-link">关于 Midway</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/midway/guide.html#快速上手" class="sidebar-link">快速上手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#安装-node-环境" class="sidebar-link">安装 Node 环境</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#创建新应用" class="sidebar-link">创建新应用</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#了解目录结构" class="sidebar-link">了解目录结构</a></li></ul></li><li><a href="/midway/guide.html#基础" class="sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#ioc-概览" class="sidebar-link">IoC 概览</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#使用装饰器" class="sidebar-link">使用装饰器</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#对象-id" class="sidebar-link">对象 id</a></li></ul></li><li><a href="/midway/guide.html#路由和控制器" class="sidebar-link">路由和控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#路由装饰器" class="sidebar-link">路由装饰器</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#路由绑定" class="sidebar-link">路由绑定</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#路由优先级" class="sidebar-link">路由优先级</a></li></ul></li><li><a href="/midway/guide.html#增强的依赖注入" class="sidebar-link">增强的依赖注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#获取-ioc-容器" class="sidebar-link">获取 IoC 容器</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#手动绑定对象" class="sidebar-link">手动绑定对象</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#配置作用域" class="sidebar-link">配置作用域</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#框架增强注入" class="sidebar-link">框架增强注入</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#构造器注入" class="sidebar-link">构造器注入</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#异步初始化" class="sidebar-link">异步初始化</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#动态函数注入" class="sidebar-link">动态函数注入</a></li></ul></li><li><a href="/midway/guide.html#应用测试" class="sidebar-link">应用测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#测试目录结构" class="sidebar-link">测试目录结构</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#测试命令" class="sidebar-link">测试命令</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#开始测试" class="sidebar-link">开始测试</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#controller-测试" class="sidebar-link">Controller 测试</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#service-测试" class="sidebar-link">Service 测试</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><div class="warning custom-block"><p class="custom-block-title">注意</p> <p>本文档还未完成，midway 还处于 beta 状态</p></div> <h1 id="midway-开发指南"><a href="#midway-开发指南" aria-hidden="true" class="header-anchor">#</a> Midway 开发指南</h1> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>Midway 自 2013 年开始，基本保持着一年一个大版本的迭代速度进行更新，从 express 到 koa1/2，从未缺席。</p> <p>如今，集团内外的 Node.js 大环境早已脱离原有的前后端分离体系，朝着全栈的方向大步迈进，有着欣喜，有着期待，对此，MidwayJs 团队不仅仅承担着引导，支撑集团 Node.js 应用的责任，也同时通过 <code>Pandora.js</code> ，<code>Sandbox</code>  等不同形式来让应用变的更加稳定，可靠。</p> <p>在 2017 年，我们将集团内部的 Midway 5.3 升级到了基于 Koa2 的模型，全面支持了 async/await 的编码风格。
''
同年年中，我们开始计划将监控和数据采集能力进行抽象剥离，形成了全新 Pandora.js 工具，不仅仅服务于 Midway，也服务于全网，乃至外部所有的 Node.js 应用。</p> <p>2018 年，MidwayJs 团队将基于 Typescript，将 Midway6 在新的语言层面进行升级，让用户在开发体验上更近一步，对外部则是从第一个版本开始。</p> <p>为什么选择 Typescript ? 相信<a href="https://juejin.im/post/59c46bc86fb9a00a4636f939" target="_blank" rel="noopener noreferrer"> 这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会给你一些答案。</p> <h2 id="关于-midway"><a href="#关于-midway" aria-hidden="true" class="header-anchor">#</a> 关于 Midway</h2> <p>Midway (中途岛) 品牌是淘宝技术部（前淘宝UED）前端部门研发的一款基于 Node.js 的全栈开发解决方案。它将搭配团队的其他产品，pandora 和 sandbox，将 Node.js 的开发体验朝着全新的场景发展，让用户在开发过程中享受到前所未有的愉悦感。</p> <h2 id="快速上手"><a href="#快速上手" aria-hidden="true" class="header-anchor">#</a> 快速上手</h2> <h3 id="安装-node-环境"><a href="#安装-node-环境" aria-hidden="true" class="header-anchor">#</a> 安装 Node 环境</h3> <p>访问 <a href="https://lark.alipay.com/alinode/handbook/env" target="_blank" rel="noopener noreferrer">Node.js 开发环境搭建<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="创建新应用"><a href="#创建新应用" aria-hidden="true" class="header-anchor">#</a> 创建新应用</h3> <p>使用 <a href="https://www.npmjs.com/package/midway-init" target="_blank" rel="noopener noreferrer">midway-init<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具自动创建 midway 应用的目录结构:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i midway-init -g
$ midway-init
</code></pre></div><p>目前只有一个 ts 的脚手架，可以直接使用。</p> <p>通过生成的 <code>npm scripts</code> 来驱动启动命令:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span>
$ <span class="token function">npm</span> run dev
</code></pre></div><h3 id="了解目录结构"><a href="#了解目录结构" aria-hidden="true" class="header-anchor">#</a> 了解目录结构</h3> <p>midway 的目录和 eggjs 目录非常接近，但也有所区别，不同的地方在于：</p> <ul><li>ts 源码存放于 <code>/src</code> 目录下，编译后代码存放于 <code>/dist</code> 下</li> <li>以往的 app 等都迁移至 <code>/src/app</code> 下，作为 web 层</li> <li>传统的业务逻辑等，移动到其他目录，比如 <code>lib/service</code></li></ul> <div class="language-plain extra-class"><pre class="language-text"><code>➜  midway6-test tree -I node_modules
.
├── README.md
├── README.zh-CN.md
├── dist                                ---- 编译后目录
├── logs                                ---- 本地日志目录
│   └── midway6-test                    ---- 日志应用名开头
│       ├── common-error.log            ---- 错误日志
│       ├── midway-agent.log            ---- agent 输出的日志
│       ├── midway-core.log             ---- 框架输出的日志
│       ├── midway-web.log              ---- koa 输出的日志
│       └── midway6-test-web.log
├── package.json
├── src                                 ---- 源码目录
│   ├── app                             ---- web 层目录
│   │   ├── controller                  ---- web 层 controller 目录
│   │   │   ├── home.ts
│   │   │   └── user.ts
│   │   ├── middleware (可选)            ---- web 层中间件目录
│   │   │   └── trace.ts
│   │   ├── public (可选)                ---- web 层静态文件目录，可以配置
│   │   ├── view (可选)
│   │   |   └── home.tpl                ---- web 层模板
│   ├── config
│   │   ├── config.default.ts
│   │   ├── config.local.ts
│   │   ├── config.prod.ts
│   │   ├── config.unittest.ts
│   │   └── plugin.ts
│   └── lib                             ---- 业务逻辑层目录
│   │   ├── interface.ts                ---- 接口定义文件
│   │   └── service                     ---- 业务逻辑层，目录根据业务自己定义
│   │       └── user.ts   
│   ├── app.ts                          ---- 应用扩展文件，可选
│   └── agent.ts                        ---- agent 扩展文件，可选
├── test
│   └── app
│       └── controller
│           └── home.test.ts
├── tsconfig.json
└── tslint.json
</code></pre></div><p>如上，由框架约定的目录：</p> <ul><li><code>app/router.ts</code> 可选，用于配置 URL 路由规则，具体参见 <a href="https://eggjs.org/zh-cn/basics/router.html" target="_blank" rel="noopener noreferrer">Router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app/controller/**</code> 用于解析用户的输入，处理后返回相应的结果，具体参见 <a href="hController">Controller</a>。</li> <li><code>app/middleware/**</code> 可选，用于编写中间件，具体参见 <a href="https://eggjs.org/zh-cn/basics/middleware.html" target="_blank" rel="noopener noreferrer">Middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app/extend/**</code> 可选，用于框架的扩展，具体参见<a href="https://eggjs.org/zh-cn/basics/extend.html" target="_blank" rel="noopener noreferrer">框架扩展<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>config/config.{env}.ts</code> 用于编写配置文件，具体参见<a href="https://eggjs.org/zh-cn/basics/config.html" target="_blank" rel="noopener noreferrer">配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>config/plugin.ts</code> 用于配置需要加载的插件，具体参见<a href="https://eggjs.org/zh-cn/basics/plugin.html" target="_blank" rel="noopener noreferrer">插件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>test/**</code> 用于单元测试，具体参见<a href="https://eggjs.org/zh-cn/core/unittest.html" target="_blank" rel="noopener noreferrer">单元测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app.ts</code> 和 <code>agent.ts</code> 用于自定义启动时的初始化工作，可选，具体参见<a href="https://eggjs.org/zh-cn/basics/app-start.html" target="_blank" rel="noopener noreferrer">启动自定义<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。关于<code>agent.js</code>的作用参见<a href="https://eggjs.org/zh-cn/core/cluster-and-ipc.html#agent-%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">Agent机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <p>由内置插件约定的目录：</p> <ul><li><code>app/public/**</code> 用于放置静态资源，可选，具体参见内置插件 <a href="https://github.com/eggjs/egg-static" target="_blank" rel="noopener noreferrer">egg-static<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app/schedule/**</code> 用于定时任务，可选，具体参见<a href="https://eggjs.org/zh-cn/basics/schedule.html" target="_blank" rel="noopener noreferrer">定时任务<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app/view/**</code> 用于放置模板文件，可选，由模板插件约定，具体参见<a href="https://eggjs.org/zh-cn/core/view.html" target="_blank" rel="noopener noreferrer">模板渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>app/model/**</code> 用于放置领域模型，可选，由领域类相关插件约定，如 <a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener noreferrer">egg-sequelize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <h2 id="基础"><a href="#基础" aria-hidden="true" class="header-anchor">#</a> 基础</h2> <h3 id="ioc-概览"><a href="#ioc-概览" aria-hidden="true" class="header-anchor">#</a> IoC 概览</h3> <p>IoC(<a href="https://en.wikipedia.org/wiki/Inversion_of_control" target="_blank" rel="noopener noreferrer">Inversion of control<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) 控制反转，是 Java Spring 中非常重要的思想和核心，有不少人是第一次听说，也不禁会有许多疑问。</p> <ul><li>什么是控制反转？</li> <li>什么是依赖注入？</li> <li>它们之间有什么关系？</li></ul> <p>软件中的对象就像齿轮一样，协同工作，但是互相耦合，一个零件不能正常工作，整个系统就崩溃了。这是一个强耦合的系统。</p> <p>现在，伴随着工业级应用的规模越来越庞大，对象之间的依赖关系也越来越复杂，经常会出现对象之间的多重依赖性关系，因此，架构师和设计师对于系统的分析和设计，将面临更大的挑战。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 常见的依赖</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">A</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./A'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">B</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./B'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
  <span class="token function">consturctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 A 被 B 和 C 所依赖，而且在构造器需要进行实例化操作，这样的依赖关系在测试中会非常麻烦。这个依赖，一般被叫做 &quot;耦合&quot;，而耦合度过高的系统，必然会出现牵一发而动全身的情形。</p> <p>为了解决对象间耦合度过高的问题，软件专家 Michael Mattson 提出了 IoC 理论，用来实现对象之间的“解耦”。</p> <p>控制反转（Inversion of Control）是一种是面向对象编程中的一种设计原则，用来减低计算机代码之间的耦合度。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 使用 IoC</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Container<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'injection'</span><span class="token punctuation">;</span> <span class="token comment">// injection 是 midway 依赖的一个包</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
  <span class="token function">consturctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 <code>container</code>  就是 IoC 容器，是依赖注入这种设计模式的一种实现，使得 C 和 A, B 没有了强耦合关系，甚至，我们可以把 C 也交给 IoC 容器，所以，IoC 容器成了整个系统的关键核心。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>IoC 容器就像是一个对象池，管理这每个对象实例的信息（Class Definition），所以用户无需关心什么时候创建，当用户希望拿到对象的实例 (Object Instance) 时，可以直接拿到实例，容器会 <strong>自动将所有依赖的对象都自动实例化</strong>。</p></div> <h3 id="使用装饰器"><a href="#使用装饰器" aria-hidden="true" class="header-anchor">#</a> 使用装饰器</h3> <p>在我们长期的实践中，得出了应用往往被分为 <code>web</code> 层以及 <code>service</code> 层的结论。而在以往的设计中，midway 已经通过 <code>getPlugin</code> 这类静态方法尽量避免不同层相互耦合和依赖，但是还是无法完全解决这个问题。</p> <p>在 Midway 6 的设计中，我们引入了 IoC 的概念，通过 ts 的高级语法糖，可以比较容易的将不同代码进行分层，解耦，这样，即使增加了 <code>manager</code> 这些层，也能够进行方便的解耦。</p> <p>midway 使用 <a href="https://www.npmjs.com/package/injection" target="_blank" rel="noopener noreferrer">injection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来作为 IoC 容器的基础，此外，midway 还扩展了请求作用域。</p> <p>Midway 6 基于 ts，参考了业界的 IoC 实现，完成了属于自己的依赖注入能力，主要是通过 <code>@provide</code> 和 <code>@inject</code> 两个装饰器来完成。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>由于使用了依赖注入体系，我们希望所有的业务代码都通过 class 语法来完成</p></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
 
  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  userModel<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到业务代码的样子和以往有着一些不同。</p> <ul><li>类加了装饰器，同时直接导出，不需要关心如何实例化</li> <li>属性加了装饰器，但是没有任何初始化以及赋值的操作即可使用</li></ul> <h4 id="provide"><a href="#provide" aria-hidden="true" class="header-anchor">#</a> @provide()</h4> <p>有了 <code>@provide()</code> 装饰器，就可以被 IoC 容器自动扫描，并绑定定义到容器上，对应的逻辑是 <a href="#%E6%89%8B%E5%8A%A8%E7%BB%91%E5%AE%9A%E5%AF%B9%E8%B1%A1">手动绑定对象</a>。</p> <p>在 midway 中，默认扫描的目录为 <code>/src/app</code> 和 <code>/src/lib</code>，在这两个目录中（包括子目录），都会被自动扫描以及加载。</p> <p><code>@provide(id?)</code> 的参数为对象 id，可选。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>@provide 装饰器是用于自动被 IoC 容器装载。</p></div> <h4 id="inject"><a href="#inject" aria-hidden="true" class="header-anchor">#</a> @inject()</h4> <p><code>@inject()</code> 的作用是将容器中的定义实例化成一个对象，并且绑定到属性中，这样，在调用的时候就可以访问到该属性。</p> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>注入的时机为构造器（new）之后，所以在构造方法(constructor)中是无法获取注入的属性的，如果要获取注入的内容，可以使用 <a href="#%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5">构造器注入</a>。</p></div> <h3 id="对象-id"><a href="#对象-id" aria-hidden="true" class="header-anchor">#</a> 对象 id</h3> <p>在默认情况下，Midway 会将类名变为 <code>驼峰</code> 形式作为对象 id，这样你可以通过容器获取实例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据字符串 id 获取实例</span>
container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 传入类名，自动根据类目获取实例</span>
</code></pre></div><p>默认情况下，Midway 的依赖注入使用的是 <code>byName</code> ，只要同名，就会自动进行注入。</p> <p>而在某些场景下，用户希望注入不同的实例，这个时候可以对默认生成的 id 进行修改。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'uModel'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserModel</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
 
  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'uModel'</span><span class="token punctuation">)</span>
  userModel<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用修改之后的 id 获取对象</span>
<span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">await</span> applicationContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同理，在使用 <code>@inject</code> 的时候也可以使用不同的 id。</p> <h2 id="路由和控制器"><a href="#路由和控制器" aria-hidden="true" class="header-anchor">#</a> 路由和控制器</h2> <p>midway 使用 koa-router 作为路由的承载着，同时在 ts 的语法上做了一些简化，我们将路由和控制器放在了一起，使用装饰器来标注路由。</p> <h3 id="路由装饰器"><a href="#路由装饰器" aria-hidden="true" class="header-anchor">#</a> 路由装饰器</h3> <p>在新的 ts 体系中，我们的控制器目录为 <code>app/controller</code> ，我们在其中编写 <code>*.ts</code> 文件。例如下面的 <code>userController.ts</code> ，我们提供了一个获取用户的接口。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
  service<span class="token punctuation">:</span> IUserService<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id<span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user<span class="token punctuation">:</span> IUserResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> user<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>我们创建了 <code>@controller</code> 装饰器用来定义这个类为 Controller，同时，提供了方法装饰器用于标注请求的类型。</p> <div class="tip custom-block"><p class="custom-block-title">小贴士</p> <p>便于大家理解，<code>@controller</code> 的参数为字符串 pattern，我们会将这个值传入 <code>router.prefix(prefix)</code> 的参数中。</p></div> <blockquote><p>注意，由于类加载是由文件扫描的顺序来保证的，有着不确定性，请不要在这里做路由顺序匹配的事情。</p></blockquote> <p>midway 针对 web 请求，提供了和 koa-router 对应的方法装饰器，列表如下。</p> <ul><li>@get</li> <li>@post</li> <li>@del</li> <li>@put</li> <li>@patch</li> <li>@options</li> <li>@head</li> <li>@all</li></ul> <p>这几个装饰器用于修饰不同的异步方法，同时对应到了 koa-router 的相应的方法。和原有提供的控制器一样，每个控制器都为异步方法，参数为 koa 上下文。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO ctx...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="路由绑定"><a href="#路由绑定" aria-hidden="true" class="header-anchor">#</a> 路由绑定</h3> <p>在以往框架的写法中，提供的 <code>app/router</code> 文件，虽然可以直接使用，但是由于控制器被 IoC 管控的关系，会有一些区别。</p> <p>和以往的写法不同的是，<strong>我们需要从容器中拿到对应的控制器实例，并绑定到路由的 pattern 上</strong>。</p> <p>假如我们有一个控制器，同时没有提供 <code>@controller</code> 装饰器，表明他不是一个控制器，在应用初始化时不会自动绑定到某个路由上，但是由于有 <code>@provide</code> 装饰器，他会被 IoC 容器所加载。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/controller/api.ts</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseApi</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>假如我们希望这个控制器可以被外部的路由使用。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/router.ts</span>

<span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/index'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">generateController</span><span class="token punctuation">(</span><span class="token string">'baseApi.index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>midway 扩展了一个 <code>app.generateController</code> 的方法来简化绑定的这个步骤，参数为 <code>ClassName.methodName</code> 的字符串形式。</p> <h3 id="路由优先级"><a href="#路由优先级" aria-hidden="true" class="header-anchor">#</a> 路由优先级</h3> <p>在单页应用下，经常会出现 <code>/*</code> 这种路由，在原本的路由文件中，我们可以通过调整代码的顺序，来使的路由的匹配顺序发生变化。而由于使用了装饰器的关系，在新题的体系无法控制文件扫描和加载顺序，这就使得路由匹配的顺序不可控。</p> <p>midway 提供了 <code>@priority(priority: number)</code> 装饰器，用于修饰 class，定义路由的优先级，默认的路由优先级为 <code>0</code>，可以设置负数让优先级降低。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">priority</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">all</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="增强的依赖注入"><a href="#增强的依赖注入" aria-hidden="true" class="header-anchor">#</a> 增强的依赖注入</h2> <h3 id="获取-ioc-容器"><a href="#获取-ioc-容器" aria-hidden="true" class="header-anchor">#</a> 获取 IoC 容器</h3> <p>所谓的容器就是一个对象池，它会在应用初始化的时候自动处理类的依赖，并将类进行实例化。比如上边的 <code>UserService</code> 类，在经过容器初始化之后，会自动实例化，并且对 <code>userModel</code> 进行赋值。</p> <p>Midway 内部使用了自动扫描的机制，在应用初始化之前，会扫描所有的文件，包含装饰器的文件会 <strong>自动绑定</strong> 到容器。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>midway 中默认为请求作用域，指的是在一次请求过程中，对象的实例保持不变，可以通过 @scope 装饰器来修改，参考 <a href="#%E9%85%8D%E7%BD%AE%E4%BD%9C%E7%94%A8%E5%9F%9F">配置作用域</a>。</p></div> <p>在大部分情况下，用于的业务逻辑和请求相关，我们将 IoC 容器绑定到了 <code>KOA Context</code> 中，即 <code>ctx.requestContext</code> ，在任意能拿到 ctx 的地方，都可以通过 <code>getAsync()</code> 方法获取对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 在 midway 中使用 IoC</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">A</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./A'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">B</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./B'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span>
  a<span class="token punctuation">;</span>
  
  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span>
  b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Midway 中获取容器有几个方法。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
midway<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="手动绑定对象"><a href="#手动绑定对象" aria-hidden="true" class="header-anchor">#</a> 手动绑定对象</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 内部代码</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>UserModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//... 省略逻辑</span>

<span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//...</span>
</code></pre></div><p>这些逻辑在 Midway 内部已经完成，绑定都会自动完成。</p> <h3 id="配置作用域"><a href="#配置作用域" aria-hidden="true" class="header-anchor">#</a> 配置作用域</h3> <p>在 midway 体系中，有三种作用域。</p> <ul><li>Singleton 单例，全局唯一（进程级别）</li> <li>Request  <strong>默认</strong>，请求作用域，生命周期随着请求链路，在请求链路上唯一，请求结束立即销毁</li> <li>Prototype 原型作用域，每次调用都会重复创建一个新的对象</li></ul> <p>在这三种作用域中，midway 的默认作用域为 <strong>请求作用域</strong>，这也意味着，如果我们需要将一个对象定义为其他两种作用域，需要额外的配置。</p> <p>midway 提供了 <code>@scope</code> 装饰器来定义一个类的作用域。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">scope</span><span class="token punctuation">(</span>ScopeEnum<span class="token punctuation">.</span>Prototype<span class="token punctuation">)</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'petrol'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PetrolEngine</span> <span class="token keyword">implements</span> <span class="token class-name">Engine</span> <span class="token punctuation">{</span>
  capacity <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">scope</span><span class="token punctuation">(</span>ScopeEnum<span class="token punctuation">.</span>Singleton<span class="token punctuation">)</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'diesel'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DieselEngine</span> <span class="token keyword">implements</span> <span class="token class-name">Engine</span> <span class="token punctuation">{</span>
  capacity <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// in IoC Container</span>
<span class="token function">assert</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'petrol'</span><span class="token punctuation">)</span> <span class="token operator">===</span> container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'petrol'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// false</span>
<span class="token function">assert</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'diesel'</span><span class="token punctuation">)</span> <span class="token operator">===</span> container<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'diesel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// true</span>
</code></pre></div><p class="warning">
  插件，在 midway 中为单例，不可配置。
</p> <h3 id="框架增强注入"><a href="#框架增强注入" aria-hidden="true" class="header-anchor">#</a> 框架增强注入</h3> <p>midway 默认使用 <a href="http://web.npm.alibaba-inc.com/package/injection" target="_blank" rel="noopener noreferrer">injection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个包来做依赖注入，虽然 <code>@inject</code> 装饰器能满足大多数业务的需求，但是对于框架来说，还有需要需要扩展和使用的地方，比如插件，配置等等。</p> <h4 id="注入插件"><a href="#注入插件" aria-hidden="true" class="header-anchor">#</a> 注入插件</h4> <p>midway 除了支持 eggjs 原本的 app.xx 的插件用法，同时，也可以通过 <code>@plugin</code> 装饰器来注入插件。</p> <p>比如我们提供了一个名字叫 <code>plugin2</code> 的插件，就可以通过属性注入的方式来修饰插件。</p> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>注意，由于在 midway 内部插件未放在 applicationContext 中，所以不能使用 @inject 来注入</p></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'plugin2'</span><span class="token punctuation">)</span>
  plugin<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>这个时候我们就需要拿到插件的名字。</p> <h4 id="查找插件名"><a href="#查找插件名" aria-hidden="true" class="header-anchor">#</a> 查找插件名</h4> <p>这个插件的名字和普通的插件名字，他是根据插件代码中的返回而定的。</p> <p>midway 会将挂载到 app 上的属性名作为基础 key。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// egg 插件经常这么做</span>
  app<span class="token punctuation">.</span>plugin1 <span class="token operator">=</span> xxxx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么 plugin1 就是插件key，midway 会在给 app 赋值时自动将返回的对象挂载到插件上下文中，供 <code>@plugin</code> 装饰器调用。</p> <h4 id="注入配置"><a href="#注入配置" aria-hidden="true" class="header-anchor">#</a> 注入配置</h4> <p>在 midway 中不同环境的 config 都会挂载到 app.config 中，但是不是所有的业务逻辑都会依赖 app 对象，所以我们构造了 <code>@config</code> 装饰器来获取配置对象。</p> <p>假如 <code>config.default.ts</code> 中有一些代码。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  config<span class="token punctuation">;</span>   <span class="token comment">// 1</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过这样，我们可以把 config 中的值直接注入到业务逻辑中。</p> <h4 id="注入日志对象"><a href="#注入日志对象" aria-hidden="true" class="header-anchor">#</a> 注入日志对象</h4> <p>在原有逻辑中，日志对象也都挂载在 app.loggers 中，通过在 config 中配置的 key 来生成不同的日志实例对象，比如插件的日志，链路的日志等。</p> <p>比如自定义一个日志，这个时候，日志的 key 则为 <code>customLogger</code> 。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> appInfo <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    customLogger<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      xxLogger<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        file<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">'logs/xx.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候可以用 <code>@logger</code> 来获取日志实例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'customLogger'</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="请求作用域中的日志"><a href="#请求作用域中的日志" aria-hidden="true" class="header-anchor">#</a> 请求作用域中的日志</h4> <p>midway 在新版本中默认对所有对象开启了请求作用域，处于该作用域下的对象，都会包含一个默认的日志对象。</p> <blockquote><p>该 logger 对象是在请求链路开始就埋入到 IoC 容器中，所以可以通过 @inject 可以获取该对象，  key 就为 logger，如果和属性同名则可以不填。</p></blockquote> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

  <span class="token comment">// 也可以直接传入 key</span>
  <span class="token comment">// @inject('logger')</span>
  <span class="token comment">// logger;</span>
  

<span class="token punctuation">}</span>
</code></pre></div><h3 id="构造器注入"><a href="#构造器注入" aria-hidden="true" class="header-anchor">#</a> 构造器注入</h3> <p>除了标准的属性注入方法之外，midway 在一定程度上支持了构造器注入的方式，来让一些应用或者三方包平稳过度。</p> <p>同样还是使用 <code>@inject</code> 装饰器。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  config<span class="token punctuation">;</span>
  plugin2<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> a<span class="token punctuation">,</span>
    @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span> config<span class="token punctuation">,</span>
    @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> b<span class="token punctuation">,</span>
    @<span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'plugin2'</span><span class="token punctuation">)</span> plugin2
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      c<span class="token punctuation">:</span> a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>c <span class="token operator">+</span> b<span class="token punctuation">.</span>config<span class="token punctuation">.</span>c <span class="token operator">+</span> config<span class="token punctuation">.</span>c
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugin2 <span class="token operator">=</span> plugin2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span> 
</code></pre></div><p>在一个类的构造器中，我们可以还可以使用其他的类似 <code>@config</code> <code>@plugin</code> <code>@logger</code> 等装饰器。只要是通过 IoC 管理的对象，都能够被自动依赖和注入。</p> <h3 id="异步初始化"><a href="#异步初始化" aria-hidden="true" class="header-anchor">#</a> 异步初始化</h3> <p>在某些情况下，我们需要一个实例在被其他依赖调用前需要初始化，如果这个初始化只是读取某个文件，那么可以写成同步方式，而如果这个初始化是从远端拿取数据或者连接某个服务，这个情况下，普通的同步代码就非常的难写。</p> <p>midway 提供了异步初始化的能力，通过 <code>@async</code>  和  <code>@init</code> 标签来管理初始化方法。</p> <p><code>@init</code> 方法目前只能是一个。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  config<span class="token punctuation">;</span>

  @<span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'plugin2'</span><span class="token punctuation">)</span>
  plugin2<span class="token punctuation">;</span>

  @<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>只要在类上标记 <code>@async</code> 装饰器之后，就代表了这个类会有异步初始化的情况，这个时候会自动通过异步的情况来调用 <code>@init</code>  标记的方法。</p> <h3 id="动态函数注入"><a href="#动态函数注入" aria-hidden="true" class="header-anchor">#</a> 动态函数注入</h3> <p>在某些场景下，我们需要函数作为某个逻辑动态执行，而 IoC 中的对象属性则都是已经创建好的，无法满足动态的逻辑需求。</p> <p>比如你需要一个工厂函数，根据不同的场景返回不同的实例，也可能有一个三方包，是个函数，在业务中想要直接调用，种种的场景下，你就需要直接注入一个函数，并且在函数中拿到上下文。</p> <p>标准的函数注入样例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">contextHandler</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// const xxx = context.getAsync('xxxx');</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">providerWrapper</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">'contextHandler'</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> contextHandler<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用端。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  contextHandler<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>midway 通过 <code>providerWrapper</code> 函数来包裹一个函数，并且指定提供的 key，供其他 IoC 对象使用。由于函数直接传递了一个 context 对象，可以轻松的通过此对象拿到所需的其他对象，而不需要管理依赖。</p> <p>函数注入大多数为了创建一个简单的工厂。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">adapterFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> IApplicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>adapterName<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>adapterName <span class="token operator">===</span> <span class="token string">'google'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'googleAdapter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>adapterName <span class="token operator">===</span> <span class="token string">'baidu'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'baiduAdapter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// return await context.getAsync(adapterName + 'Adapter');</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">providerWrapper</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">'adapterFactory'</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> adapterFactory<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样在业务中，可以直接来使用了。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>
@<span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'adapterName'</span><span class="token punctuation">)</span>
  adapterName<span class="token punctuation">;</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'adapterFactory'</span><span class="token punctuation">)</span>
  factory<span class="token punctuation">;</span>

  adapter<span class="token punctuation">:</span> Adapter<span class="token punctuation">;</span>

  @<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>adapter <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adapterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>这个函数可以是异步的 (async)。</p></div> <p>比如如果应用希望自己使用 sequelize， 而 sequelize 的创建 model 的过程是个异步操作。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> providerWrapper<span class="token punctuation">,</span> IApplicationContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Sequelize <span class="token keyword">from</span> <span class="token string">'sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Sequelize <span class="token keyword">as</span> SequelizeInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'sequelize'</span><span class="token punctuation">;</span>

<span class="token comment">// 可以直接写 async 方法</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">factory</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> IApplicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>getAsync<span class="token operator">&lt;</span>SequelizeInstance<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'coreDB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> UiKeyTraceModel <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    gmtCreate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      field<span class="token punctuation">:</span> <span class="token string">'gmt_create'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    gmtModified<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      field<span class="token punctuation">:</span> <span class="token string">'gmt_modified'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    createdAt<span class="token punctuation">:</span> <span class="token string">'gmt_create'</span><span class="token punctuation">,</span>
    updatedAt<span class="token punctuation">:</span> <span class="token string">'gmt_modified'</span><span class="token punctuation">,</span>
    freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    tableName<span class="token punctuation">:</span> <span class="token string">'xxxx'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> UiKeyTraceModel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">providerWrapper</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">'keyTraceModel'</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> factory
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="应用测试"><a href="#应用测试" aria-hidden="true" class="header-anchor">#</a> 应用测试</h2> <p>经过大量的实践，我们沉淀出了一套标准的测试工具集。</p> <ul><li>测试工具包 <a href="https://www.npmjs.com/package/midway-bin" target="_blank" rel="noopener noreferrer">midway-bin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>测试框架 mocha</li> <li>测试断言库 assert/chai</li> <li>测试模拟 <a href="https://www.npmjs.com/package/midway-mock" target="_blank" rel="noopener noreferrer">midway-mock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="测试目录结构"><a href="#测试目录结构" aria-hidden="true" class="header-anchor">#</a> 测试目录结构</h3> <p>我们约定 <code>test</code> 目录为存放所有测试脚本的目录，测试所使用到的 <code>fixtures</code> 和相关辅助脚本都应该放在此目录下。</p> <p>测试脚本文件统一按 <code>${filename}.test.ts</code> 命名，必须以 <code>.test.ts</code> 作为文件后缀。</p> <p>一个应用的测试目录示例：</p> <div class="language-plain extra-class"><pre class="language-text"><code>test
├── controller
│   └── home.test.ts
├── hello.test.ts
└── service
    └── user.test.ts

</code></pre></div><h3 id="测试命令"><a href="#测试命令" aria-hidden="true" class="header-anchor">#</a> 测试命令</h3> <p>在脚手架中，我们已经将常见的命令进行内置，可能略微有些不同，大致代码如下。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin test --ts&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cov&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin cov --ts&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span data-type="color" style="color:rgb(88, 88, 88)"><span data-type="background" style="background-color:rgb(255, 255, 255)">然后就可以按标准的 </span></span><code>npm test</code><span data-type="color" style="color:rgb(88, 88, 88)"><span data-type="background" style="background-color:rgb(255, 255, 255)"></span></span>来运行测试了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">test</span>

<span class="token operator">&gt;</span> unittest-example@ <span class="token function">test</span> /Users/harry/midwayj/examples/unittest
<span class="token operator">&gt;</span> midway-bin <span class="token function">test</span> --ts

  test/hello.test.ts
    ✓ should work

  1 passing <span class="token punctuation">(</span>10ms<span class="token punctuation">)</span>

</code></pre></div><h3 id="开始测试"><a href="#开始测试" aria-hidden="true" class="header-anchor">#</a> 开始测试</h3> <p>在测试运行之前，我们首先要创建应用的一个 app 实例， 通过它来访问需要被测试的 Controller、Middleware、Service 等应用层代码。</p> <p>通过 <code>midway-mock</code>，结合 Mocha 的 <code>before</code> 钩子就可以便捷地创建出一个 app 实例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.js</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token punctuation">;</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建当前应用的 app 实例</span>
    app <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 app 启动成功，才能执行测试用例</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样我们就拿到了一个 app 的引用，接下来所有测试用例都会基于这个 app 进行。 更多关于创建 app 的信息请查看 <a href="https://github.com/eggjs/egg-mock#options" target="_blank" rel="noopener noreferrer">mm.app(options)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <p>每一个测试文件都需要这样创建一个 app 实例非常冗余，因此 <code>midway-mock</code> 提供了一个 bootstrap 文件，可以直接从它上面拿到我们所常用的实例：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// test cases</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="controller-测试"><a href="#controller-测试" aria-hidden="true" class="header-anchor">#</a> Controller 测试</h3> <p>我们可以通过 app.httpRequest() <a href="https://github.com/visionmedia/supertest" target="_blank" rel="noopener noreferrer">SuperTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 发起一个真实的 HTTP 请求来进行测试。app.httpRequest() 是 midway-mock 封装的 SuperTest 请求实例。</p> <p>例如我们要给 <code>app/controller/home.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> controller<span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>
  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Welcome to midwayjs!`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写一个完整的单元测试，它的测试代码 <code>test/controller/home.test.ts</code> 如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should GET /'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对 app 发起 `GET /` 请求</span>
    <span class="token keyword">return</span> app
      <span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Welcome to midwayjs!'</span><span class="token punctuation">)</span> <span class="token comment">// 期望 body 是 hello world</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 期望返回 status 200</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过基于 SuperTest 的 app.httpRequest() 可以轻松发起 GET、POST、PUT 等 HTTP 请求，并且它有非常丰富的请求数据构造接口，请查看 <a href="https://github.com/visionmedia/supertest#getting-started" target="_blank" rel="noopener noreferrer">SuperTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <h3 id="service-测试"><a href="#service-测试" aria-hidden="true" class="header-anchor">#</a> Service 测试</h3> <p>由于 midway 提倡使用 IoC 的方式来定义 service，所以编码与测试都与 eggjs 有明显的区别。</p> <p>例如 <code>src/lib/service/user.ts</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService<span class="token punctuation">,</span> IUserOptions<span class="token punctuation">,</span> IUserResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../interface'</span><span class="token punctuation">;</span>

<span class="token comment">// 装载 service 到 IoC 容器</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> IUserOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 10ms 之后返回用户数据</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> options<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          username<span class="token punctuation">:</span> <span class="token string">'mockedName'</span><span class="token punctuation">,</span>
          phone<span class="token punctuation">:</span> <span class="token string">'12345678901'</span><span class="token punctuation">,</span>
          email<span class="token punctuation">:</span> <span class="token string">'xxx.xxx@xxx.com'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>编写单元测试 <code>test/service/user.test.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../src/interface'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/service/user.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'#getUser'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取出 userService</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span>getAsync<span class="token operator">&lt;</span>IUserService<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token string">'mockedName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>app.applicationContext 是 IoC 容器的应用上下文, 通过它可以异步取出注入的 service，并使用 service 进行测试。完整 demo 可以参见 <a href="https://github.com/Lellansin/midway-test-demo" target="_blank" rel="noopener noreferrer">midway-test-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/midwayjs/midway/edit/master/docs/guide.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/midway/assets/js/6.5a189156.js" defer></script><script src="/midway/assets/js/app.11a95031.js" defer></script>
  </body>
</html>
